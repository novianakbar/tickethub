"use client";

import { useState, useEffect, use, useCallback, useRef } from "react";
import Link from "next/link";
import { AdminHeader } from "@/components/layout/AdminHeader";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Textarea } from "@/components/ui/textarea";
import {
    Card,
    CardContent,
    CardHeader,
    CardTitle,
} from "@/components/ui/card";
import { Separator } from "@/components/ui/separator";
import { Label } from "@/components/ui/label";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { toast } from "sonner";
import { cn } from "@/lib/utils";
import {
    ArrowLeft,
    Loader2,
    Send,
    MessageSquare,
    FileText,
    Clock,
    AlertCircle,
    Mail,
    Phone,
    Paperclip,
    Download,
    Image as ImageIcon,
    Eye,
    Upload,
    Plus,
    Trash2,
} from "lucide-react";

// Import optimized components
import {
    TicketDetailSidebar,
    QuickActionsBar,
    TicketTimeline,
} from "@/components/tickets";
import { AttachmentViewer, useAttachmentViewer } from "@/components/AttachmentViewer";

interface TicketDetail {
    id: string;
    ticketNumber: string;
    subject: string;
    description: string;
    status: "open" | "in_progress" | "pending" | "resolved" | "closed";
    priority: "low" | "normal" | "high" | "urgent";
    level: "L1" | "L2" | "L3";
    source: string;
    customerName: string;
    customerEmail: string;
    customerPhone: string | null;
    customerCompany: string | null;
    dueDate?: string | null;
    createdAt: string;
    updatedAt: string;
    resolvedAt: string | null;
    closedAt: string | null;
    category: {
        id: string;
        name: string;
        color: string;
    };
    assignee: {
        id: string;
        fullName: string | null;
        email: string;
    } | null;
    createdBy: {
        id: string;
        fullName: string | null;
        email: string;
    };
    replies: Array<{
        id: string;
        message: string;
        createdAt: string;
        author: {
            id: string;
            fullName: string | null;
            email: string;
        };
        attachments?: Array<{
            id: string;
            fileName: string;
            fileUrl: string;
            fileSize: number;
            fileType: string;
        }>;
    }>;
    notes: Array<{
        id: string;
        content: string;
        createdAt: string;
        author: {
            id: string;
            fullName: string | null;
            email: string;
        };
        attachments?: Array<{
            id: string;
            fileName: string;
            fileUrl: string;
            fileSize: number;
            fileType: string;
        }>;
    }>;
    activities: Array<{
        id: string;
        type: string;
        description: string;
        createdAt: string;
        author: {
            id: string;
            fullName: string | null;
            email: string;
        };
    }>;
    attachments: Array<{
        id: string;
        fileName: string;
        fileUrl: string;
        fileSize: number;
        fileType: string;
        createdAt: string;
    }>;
}

const levelConfig = {
    L1: { label: "L1 - Support", className: "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400", border: "border-l-blue-500" },
    L2: { label: "L2 - Specialist", className: "bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400", border: "border-l-orange-500" },
    L3: { label: "L3 - Expert", className: "bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400", border: "border-l-purple-500" },
};

const statusConfig = {
    open: { label: "Menunggu", className: "bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400" },
    in_progress: { label: "Diproses", className: "bg-yellow-100 text-yellow-700 dark:bg-yellow-900/30 dark:text-yellow-400" },
    pending: { label: "Pending", className: "bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-400" },
    resolved: { label: "Selesai", className: "bg-green-100 text-green-700 dark:bg-green-900/30 dark:text-green-400" },
    closed: { label: "Ditutup", className: "bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-400" },
};

const priorityConfig = {
    low: { label: "Rendah", className: "text-gray-500" },
    normal: { label: "Normal", className: "text-blue-500" },
    high: { label: "Tinggi", className: "text-orange-500" },
    urgent: { label: "Mendesak", className: "text-red-500 font-semibold" },
};

function formatDateTime(dateString: string): string {
    return new Date(dateString).toLocaleString("id-ID", {
        day: "numeric",
        month: "short",
        year: "numeric",
        hour: "2-digit",
        minute: "2-digit",
    });
}

function getInitials(name: string): string {
    return name.split(" ").map(n => n[0]).join("").substring(0, 2).toUpperCase();
}

export default function AdminTicketDetailPage({
    params,
}: {
    params: Promise<{ id: string }>;
}) {
    const { id } = use(params);
    const [ticket, setTicket] = useState<TicketDetail | null>(null);
    const [isLoading, setIsLoading] = useState(true);
    const [replyText, setReplyText] = useState("");
    const [noteText, setNoteText] = useState("");
    const [isSubmitting, setIsSubmitting] = useState(false);
    const [isUploading, setIsUploading] = useState(false);
    const fileInputRef = useRef<HTMLInputElement>(null);
    const replyFileInputRef = useRef<HTMLInputElement>(null);
    const noteFileInputRef = useRef<HTMLInputElement>(null);
    const attachmentViewer = useAttachmentViewer();

    // Attachments for reply and note forms
    const [replyAttachments, setReplyAttachments] = useState<{
        fileName: string;
        fileKey: string;
        fileUrl: string;
        fileSize: number;
        fileType: string;
    }[]>([]);
    const [noteAttachments, setNoteAttachments] = useState<{
        fileName: string;
        fileKey: string;
        fileUrl: string;
        fileSize: number;
        fileType: string;
    }[]>([]);
    const [isUploadingReply, setIsUploadingReply] = useState(false);
    const [isUploadingNote, setIsUploadingNote] = useState(false);

    const fetchTicket = useCallback(async () => {
        try {
            const res = await fetch(`/api/tickets/${id}`);
            if (res.ok) {
                const data = await res.json();
                setTicket(data.ticket);
            } else {
                toast.error("Gagal memuat tiket");
            }
        } catch (error) {
            console.error("Fetch error:", error);
            toast.error("Terjadi kesalahan");
        } finally {
            setIsLoading(false);
        }
    }, [id]);

    useEffect(() => {
        fetchTicket();
    }, [fetchTicket]);

    const handleStatusChange = async (newStatus: string) => {
        if (!ticket) return;
        try {
            const res = await fetch(`/api/tickets/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ status: newStatus }),
            });
            if (res.ok) {
                toast.success("Status berhasil diubah");
                fetchTicket();
            } else {
                toast.error("Gagal mengubah status");
            }
        } catch (error) {
            console.error("Update error:", error);
        }
    };

    const handlePriorityChange = async (newPriority: string) => {
        if (!ticket) return;
        try {
            const res = await fetch(`/api/tickets/${id}`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ priority: newPriority }),
            });
            if (res.ok) {
                toast.success("Prioritas berhasil diubah");
                fetchTicket();
            } else {
                toast.error("Gagal mengubah prioritas");
            }
        } catch (error) {
            console.error("Update error:", error);
        }
    };

    const handleEscalate = async () => {
        if (!ticket) return;
        try {
            const res = await fetch(`/api/tickets/${id}/escalate`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({}),
            });
            if (res.ok) {
                toast.success("Tiket berhasil dieskalasi");
                fetchTicket();
            } else {
                const error = await res.json();
                toast.error(error.error || "Gagal eskalasi");
            }
        } catch (error) {
            console.error("Escalate error:", error);
        }
    };

    const handleSendReply = async () => {
        if (!replyText.trim()) return;
        setIsSubmitting(true);
        try {
            const res = await fetch(`/api/tickets/${id}/reply`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    message: replyText,
                    attachments: replyAttachments.length > 0 ? replyAttachments : undefined,
                }),
            });
            if (res.ok) {
                toast.success("Balasan berhasil dikirim");
                setReplyText("");
                setReplyAttachments([]);
                fetchTicket();
            } else {
                toast.error("Gagal mengirim balasan");
            }
        } catch (error) {
            console.error("Reply error:", error);
        } finally {
            setIsSubmitting(false);
        }
    };

    const handleAddNote = async () => {
        if (!noteText.trim()) return;
        setIsSubmitting(true);
        try {
            const res = await fetch(`/api/tickets/${id}/note`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    content: noteText,
                    attachments: noteAttachments.length > 0 ? noteAttachments : undefined,
                }),
            });
            if (res.ok) {
                toast.success("Catatan berhasil ditambahkan");
                setNoteText("");
                setNoteAttachments([]);
                fetchTicket();
            } else {
                toast.error("Gagal menambah catatan");
            }
        } catch (error) {
            console.error("Note error:", error);
        } finally {
            setIsSubmitting(false);
        }
    };

    // Upload handler for reply attachments
    const handleReplyFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
        const files = e.target.files;
        if (!files || files.length === 0) return;

        setIsUploadingReply(true);
        for (const file of Array.from(files)) {
            const formData = new FormData();
            formData.append("file", file);
            formData.append("folder", "replies");

            try {
                const res = await fetch("/api/upload", {
                    method: "POST",
                    body: formData,
                });
                if (res.ok) {
                    const data = await res.json();
                    setReplyAttachments((prev) => [...prev, {
                        fileName: data.file.name,
                        fileKey: data.file.key,
                        fileUrl: data.file.url,
                        fileSize: data.file.size,
                        fileType: data.file.type,
                    }]);
                } else {
                    const error = await res.json();
                    toast.error(error.error || `Gagal upload ${file.name}`);
                }
            } catch (error) {
                console.error("Upload error:", error);
                toast.error(`Gagal upload ${file.name}`);
            }
        }
        setIsUploadingReply(false);
        if (replyFileInputRef.current) {
            replyFileInputRef.current.value = "";
        }
    };

    // Upload handler for note attachments
    const handleNoteFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
        const files = e.target.files;
        if (!files || files.length === 0) return;

        setIsUploadingNote(true);
        for (const file of Array.from(files)) {
            const formData = new FormData();
            formData.append("file", file);
            formData.append("folder", "notes");

            try {
                const res = await fetch("/api/upload", {
                    method: "POST",
                    body: formData,
                });
                if (res.ok) {
                    const data = await res.json();
                    setNoteAttachments((prev) => [...prev, {
                        fileName: data.file.name,
                        fileKey: data.file.key,
                        fileUrl: data.file.url,
                        fileSize: data.file.size,
                        fileType: data.file.type,
                    }]);
                } else {
                    const error = await res.json();
                    toast.error(error.error || `Gagal upload ${file.name}`);
                }
            } catch (error) {
                console.error("Upload error:", error);
                toast.error(`Gagal upload ${file.name}`);
            }
        }
        setIsUploadingNote(false);
        if (noteFileInputRef.current) {
            noteFileInputRef.current.value = "";
        }
    };

    // Handle file upload for attachments
    const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
        const files = e.target.files;
        if (!files || files.length === 0) return;

        setIsUploading(true);
        const uploadedFiles: Array<{
            fileName: string;
            fileKey: string;
            fileUrl: string;
            fileSize: number;
            fileType: string;
        }> = [];

        for (const file of Array.from(files)) {
            try {
                const formData = new FormData();
                formData.append("file", file);
                formData.append("folder", "tickets");

                const res = await fetch("/api/upload", {
                    method: "POST",
                    body: formData,
                });

                if (res.ok) {
                    const data = await res.json();
                    // Map upload API response to attachments format
                    uploadedFiles.push({
                        fileName: data.file.name,
                        fileKey: data.file.key,
                        fileUrl: data.file.url,
                        fileSize: data.file.size,
                        fileType: data.file.type,
                    });
                } else {
                    const error = await res.json();
                    toast.error(error.error || `Gagal upload ${file.name}`);
                }
            } catch (error) {
                console.error("Upload error:", error);
                toast.error(`Gagal upload ${file.name}`);
            }
        }

        // Add attachments to ticket
        if (uploadedFiles.length > 0) {
            try {
                const res = await fetch(`/api/tickets/${id}/attachments`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ attachments: uploadedFiles }),
                });

                if (res.ok) {
                    toast.success(`${uploadedFiles.length} lampiran berhasil ditambahkan`);
                    fetchTicket();
                } else {
                    toast.error("Gagal menyimpan lampiran ke tiket");
                }
            } catch (error) {
                console.error("Save attachment error:", error);
                toast.error("Gagal menyimpan lampiran");
            }
        }

        setIsUploading(false);
        if (fileInputRef.current) {
            fileInputRef.current.value = "";
        }
    };

    // Handle delete attachment
    const handleDeleteAttachment = async (attachmentId: string) => {
        if (!confirm("Hapus lampiran ini?")) return;

        try {
            const res = await fetch(`/api/attachments/${attachmentId}`, {
                method: "DELETE",
            });

            if (res.ok) {
                toast.success("Lampiran berhasil dihapus");
                fetchTicket();
            } else {
                toast.error("Gagal menghapus lampiran");
            }
        } catch (error) {
            console.error("Delete attachment error:", error);
            toast.error("Terjadi kesalahan");
        }
    };

    if (isLoading) {
        return (
            <>
                <AdminHeader title="Loading..." />
                <div className="flex-1 flex items-center justify-center">
                    <Loader2 className="h-8 w-8 animate-spin text-primary" />
                </div>
            </>
        );
    }

    if (!ticket) {
        return (
            <>
                <AdminHeader title="Tiket tidak ditemukan" />
                <div className="flex-1 flex flex-col items-center justify-center">
                    <AlertCircle className="h-12 w-12 text-muted-foreground mb-4" />
                    <p className="text-muted-foreground">Tiket tidak ditemukan</p>
                    <Button asChild className="mt-4">
                        <Link href="/admin/tickets">Kembali</Link>
                    </Button>
                </div>
            </>
        );
    }

    return (
        <>
            <AdminHeader
                title={`Tiket ${ticket.ticketNumber}`}
                description={ticket.subject}
            />

            <div className="flex-1 overflow-auto p-6">
                {/* Back Link */}
                <Link
                    href="/admin/tickets"
                    className="mb-4 inline-flex items-center gap-1.5 text-sm text-muted-foreground hover:text-foreground transition-colors"
                >
                    <ArrowLeft className="h-4 w-4" />
                    Kembali ke daftar tiket
                </Link>

                {/* Quick Actions Bar - Primary workflow actions */}
                <div className="mb-6">
                    <QuickActionsBar
                        ticketNumber={ticket.ticketNumber}
                        status={ticket.status}
                        level={ticket.level}
                        onStatusChange={handleStatusChange}
                        onEscalate={handleEscalate}
                    />
                </div>

                <div className="grid gap-4 lg:grid-cols-3">
                    {/* Main Content */}
                    <div className="lg:col-span-2 space-y-4">
                        {/* Ticket Header Card - Combined with Customer Info */}
                        <Card className={cn("border-l-4", levelConfig[ticket.level].border)}>
                            <CardHeader className="pb-3">
                                <div className="flex items-start gap-3">
                                    {/* Customer Avatar */}
                                    <div className="flex h-11 w-11 shrink-0 items-center justify-center rounded-full bg-primary/10 text-primary font-semibold">
                                        {getInitials(ticket.customerName)}
                                    </div>

                                    <div className="flex-1 min-w-0">
                                        {/* Customer Name & Company */}
                                        <div className="flex flex-wrap items-center gap-x-2 gap-y-1">
                                            <span className="font-semibold">{ticket.customerName}</span>
                                            {ticket.customerCompany && (
                                                <span className="text-sm text-muted-foreground">• {ticket.customerCompany}</span>
                                            )}
                                        </div>

                                        {/* Contact Info - Inline */}
                                        <div className="flex flex-wrap items-center gap-x-3 gap-y-1 text-sm text-muted-foreground mt-0.5">
                                            <a href={`mailto:${ticket.customerEmail}`} className="hover:text-primary transition-colors inline-flex items-center gap-1">
                                                <Mail className="h-3 w-3" />
                                                {ticket.customerEmail}
                                            </a>
                                            {ticket.customerPhone && (
                                                <a href={`tel:${ticket.customerPhone}`} className="hover:text-primary transition-colors inline-flex items-center gap-1">
                                                    <Phone className="h-3 w-3" />
                                                    {ticket.customerPhone}
                                                </a>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </CardHeader>
                            <CardContent className="space-y-3 pt-0">
                                {/* Badges Row */}
                                <div className="flex flex-wrap items-center gap-2">
                                    <Badge variant="outline" className={cn("text-xs", levelConfig[ticket.level].className)}>
                                        {levelConfig[ticket.level].label}
                                    </Badge>
                                    <Badge className={cn("text-xs", statusConfig[ticket.status].className)}>
                                        {statusConfig[ticket.status].label}
                                    </Badge>
                                    <span className={cn("text-xs", priorityConfig[ticket.priority].className)}>
                                        {ticket.priority === "urgent" && <AlertCircle className="h-3 w-3 inline mr-1" />}
                                        {priorityConfig[ticket.priority].label}
                                    </span>
                                    <Badge
                                        variant="outline"
                                        className="text-xs"
                                        style={{ borderColor: ticket.category.color, color: ticket.category.color }}
                                    >
                                        {ticket.category.name}
                                    </Badge>
                                    <span className="text-xs text-muted-foreground">
                                        • {formatDateTime(ticket.createdAt)}
                                    </span>
                                </div>

                                {/* Subject */}
                                <h2 className="text-base font-semibold">
                                    {ticket.subject}
                                </h2>

                                {/* Description */}
                                <div className="rounded-lg bg-muted/50 p-3">
                                    <p className="text-sm leading-relaxed whitespace-pre-wrap">
                                        {ticket.description}
                                    </p>
                                </div>

                                {/* Attachments - Inline */}
                                <div className="pt-2">
                                    <div className="flex items-center justify-between mb-2">
                                        <p className="text-xs font-medium text-muted-foreground flex items-center gap-1">
                                            <Paperclip className="h-3 w-3" />
                                            Lampiran ({ticket.attachments.length})
                                        </p>
                                        <div>
                                            <input
                                                ref={fileInputRef}
                                                type="file"
                                                className="hidden"
                                                accept=".pdf,.jpg,.jpeg,.png,.gif,.webp,.doc,.docx"
                                                multiple
                                                onChange={handleFileUpload}
                                            />
                                            <Button
                                                variant="ghost"
                                                size="sm"
                                                onClick={() => fileInputRef.current?.click()}
                                                disabled={isUploading}
                                                className="h-7 text-xs"
                                            >
                                                {isUploading ? (
                                                    <Loader2 className="h-3 w-3 animate-spin" />
                                                ) : (
                                                    <Plus className="h-3 w-3" />
                                                )}
                                                {isUploading ? "Uploading..." : "Tambah"}
                                            </Button>
                                        </div>
                                    </div>
                                    {ticket.attachments.length > 0 ? (
                                        <div className="flex flex-wrap gap-2">
                                            {ticket.attachments.map((att) => (
                                                <div key={att.id} className="group relative">
                                                    <button
                                                        type="button"
                                                        onClick={() => attachmentViewer.openViewer(att)}
                                                        className="text-left"
                                                    >
                                                        {att.fileType.startsWith("image/") ? (
                                                            <div className="relative h-16 w-16 rounded-md overflow-hidden border bg-muted">
                                                                {/* eslint-disable-next-line @next/next/no-img-element */}
                                                                <img src={att.fileUrl} alt={att.fileName} className="h-full w-full object-cover" />
                                                                <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                                                    <Eye className="h-4 w-4 text-white" />
                                                                </div>
                                                            </div>
                                                        ) : (
                                                            <div className="flex items-center gap-2 rounded-md border px-2 py-1.5 text-xs hover:bg-muted transition-colors">
                                                                <FileText className="h-4 w-4 text-red-500" />
                                                                <span className="max-w-[100px] truncate">{att.fileName}</span>
                                                                {att.fileType.includes("pdf") ? (
                                                                    <Eye className="h-3 w-3 text-muted-foreground" />
                                                                ) : (
                                                                    <Download className="h-3 w-3 text-muted-foreground" />
                                                                )}
                                                            </div>
                                                        )}
                                                    </button>
                                                    <button
                                                        onClick={() => handleDeleteAttachment(att.id)}
                                                        className="absolute -top-1 -right-1 h-5 w-5 rounded-full bg-red-500 text-white opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center hover:bg-red-600"
                                                        title="Hapus"
                                                    >
                                                        <Trash2 className="h-3 w-3" />
                                                    </button>
                                                </div>
                                            ))}
                                        </div>
                                    ) : (
                                        <p className="text-xs text-muted-foreground">Belum ada lampiran</p>
                                    )}
                                </div>
                            </CardContent>
                        </Card>

                        {/* Activity & Notes Tabs */}
                        <Card>
                            <Tabs defaultValue="replies">
                                <CardHeader className="pb-3">
                                    <TabsList className="grid w-full grid-cols-3">
                                        <TabsTrigger value="replies" className="gap-1.5">
                                            <MessageSquare className="h-4 w-4" />
                                            <span className="hidden sm:inline">Balasan</span>
                                            {ticket.replies.length > 0 && (
                                                <span className="ml-1 rounded-full bg-primary/10 px-1.5 py-0.5 text-xs font-medium">
                                                    {ticket.replies.length}
                                                </span>
                                            )}
                                        </TabsTrigger>
                                        <TabsTrigger value="notes" className="gap-1.5">
                                            <FileText className="h-4 w-4" />
                                            <span className="hidden sm:inline">Catatan</span>
                                            {ticket.notes.length > 0 && (
                                                <span className="ml-1 rounded-full bg-amber-100 dark:bg-amber-900/30 px-1.5 py-0.5 text-xs font-medium text-amber-700 dark:text-amber-400">
                                                    {ticket.notes.length}
                                                </span>
                                            )}
                                        </TabsTrigger>
                                        <TabsTrigger value="activity" className="gap-1.5">
                                            <Clock className="h-4 w-4" />
                                            <span className="hidden sm:inline">Aktivitas</span>
                                        </TabsTrigger>
                                    </TabsList>
                                </CardHeader>
                                <CardContent>
                                    {/* Replies Tab */}
                                    <TabsContent value="replies" className="mt-0">
                                        <div className="space-y-4">
                                            {ticket.replies.length === 0 ? (
                                                <div className="rounded-lg border border-dashed p-6 text-center">
                                                    <MessageSquare className="mx-auto h-8 w-8 text-muted-foreground mb-2" />
                                                    <p className="text-sm text-muted-foreground">
                                                        Belum ada balasan
                                                    </p>
                                                </div>
                                            ) : (
                                                ticket.replies.map((reply) => (
                                                    <div key={reply.id} className="rounded-lg border p-4">
                                                        <div className="flex items-center justify-between mb-2">
                                                            <div className="flex items-center gap-2">
                                                                <div className="h-8 w-8 rounded-full bg-primary/10 flex items-center justify-center text-sm font-medium text-primary">
                                                                    {getInitials(reply.author.fullName || reply.author.email)}
                                                                </div>
                                                                <span className="text-sm font-medium">
                                                                    {reply.author.fullName || reply.author.email}
                                                                </span>
                                                            </div>
                                                            <span className="text-xs text-muted-foreground">
                                                                {formatDateTime(reply.createdAt)}
                                                            </span>
                                                        </div>
                                                        <p className="text-sm whitespace-pre-wrap">{reply.message}</p>
                                                        {reply.attachments && reply.attachments.length > 0 && (
                                                            <div className="flex flex-wrap gap-2 mt-2 pt-2 border-t">
                                                                {reply.attachments.map((att: { id: string; fileName: string; fileUrl: string; fileType: string; fileSize: number }) => (
                                                                    <button
                                                                        key={att.id}
                                                                        onClick={() => attachmentViewer.openViewer(att)}
                                                                        className="flex items-center gap-1 text-xs border rounded px-2 py-1 bg-muted/50 hover:bg-muted transition-colors"
                                                                    >
                                                                        {att.fileType.startsWith("image/") ? (
                                                                            <ImageIcon className="h-3 w-3 text-blue-500" />
                                                                        ) : (
                                                                            <FileText className="h-3 w-3 text-red-500" />
                                                                        )}
                                                                        <span className="truncate max-w-[100px]">{att.fileName}</span>
                                                                    </button>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                ))
                                            )}
                                        </div>

                                        <Separator className="my-4" />

                                        <div className="space-y-3">
                                            <div className="flex items-start gap-2 p-3 rounded-lg bg-blue-50 dark:bg-blue-950/30 border border-blue-200 dark:border-blue-800">
                                                <Mail className="h-4 w-4 text-blue-600 dark:text-blue-400 mt-0.5 shrink-0" />
                                                <div className="text-xs text-blue-700 dark:text-blue-300">
                                                    <span className="font-semibold">Balasan akan terlihat oleh pelanggan.</span>
                                                    <span className="ml-1">Pastikan isi pesan sopan dan informatif.</span>
                                                </div>
                                            </div>
                                            <Label className="text-sm font-medium">Tulis Balasan</Label>
                                            <Textarea
                                                placeholder="Tulis balasan untuk pelanggan..."
                                                rows={3}
                                                value={replyText}
                                                onChange={(e) => setReplyText(e.target.value)}
                                                className="resize-none"
                                            />

                                            {/* Reply Attachments */}
                                            {replyAttachments.length > 0 && (
                                                <div className="flex flex-wrap gap-2">
                                                    {replyAttachments.map((att, idx) => (
                                                        <div key={idx} className="flex items-center gap-1 text-xs border rounded px-2 py-1 bg-muted/50">
                                                            <Paperclip className="h-3 w-3" />
                                                            <span className="truncate max-w-[120px]">{att.fileName}</span>
                                                            <button
                                                                type="button"
                                                                onClick={() => setReplyAttachments(prev => prev.filter((_, i) => i !== idx))}
                                                                className="text-muted-foreground hover:text-red-500"
                                                            >
                                                                ×
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}

                                            <div className="flex items-center gap-2">
                                                <input
                                                    ref={replyFileInputRef}
                                                    type="file"
                                                    className="hidden"
                                                    accept=".pdf,.jpg,.jpeg,.png,.gif,.webp,.doc,.docx"
                                                    multiple
                                                    onChange={handleReplyFileUpload}
                                                />
                                                <Button
                                                    type="button"
                                                    variant="outline"
                                                    size="sm"
                                                    onClick={() => replyFileInputRef.current?.click()}
                                                    disabled={isUploadingReply}
                                                >
                                                    {isUploadingReply ? (
                                                        <Loader2 className="h-4 w-4 animate-spin" />
                                                    ) : (
                                                        <Paperclip className="h-4 w-4" />
                                                    )}
                                                    Lampiran
                                                </Button>
                                                <Button onClick={handleSendReply} disabled={isSubmitting || !replyText.trim()}>
                                                    <Send className="h-4 w-4" />
                                                    {isSubmitting ? "Mengirim..." : "Kirim Balasan"}
                                                </Button>
                                            </div>
                                        </div>
                                    </TabsContent>

                                    {/* Notes Tab */}
                                    <TabsContent value="notes" className="mt-0">
                                        <div className="space-y-4">
                                            {ticket.notes.length === 0 ? (
                                                <div className="rounded-lg border border-dashed p-6 text-center">
                                                    <FileText className="mx-auto h-8 w-8 text-muted-foreground mb-2" />
                                                    <p className="text-sm text-muted-foreground">
                                                        Belum ada catatan internal
                                                    </p>
                                                </div>
                                            ) : (
                                                ticket.notes.map((note) => (
                                                    <div key={note.id} className="rounded-lg border-l-2 border-l-amber-500 bg-amber-50/50 dark:bg-amber-900/10 p-4">
                                                        <div className="flex items-center justify-between mb-2">
                                                            <span className="text-sm font-medium">
                                                                {note.author.fullName || note.author.email}
                                                            </span>
                                                            <span className="text-xs text-muted-foreground">
                                                                {formatDateTime(note.createdAt)}
                                                            </span>
                                                        </div>
                                                        <p className="text-sm whitespace-pre-wrap">{note.content}</p>
                                                        {note.attachments && note.attachments.length > 0 && (
                                                            <div className="flex flex-wrap gap-2 mt-2 pt-2 border-t border-amber-200 dark:border-amber-800">
                                                                {note.attachments.map((att) => (
                                                                    <button
                                                                        key={att.id}
                                                                        onClick={() => attachmentViewer.openViewer(att)}
                                                                        className="flex items-center gap-1 text-xs border rounded px-2 py-1 bg-amber-100/50 dark:bg-amber-900/30 hover:bg-amber-100 dark:hover:bg-amber-900/50 transition-colors"
                                                                    >
                                                                        {att.fileType.startsWith("image/") ? (
                                                                            <ImageIcon className="h-3 w-3 text-blue-500" />
                                                                        ) : (
                                                                            <FileText className="h-3 w-3 text-red-500" />
                                                                        )}
                                                                        <span className="truncate max-w-[100px]">{att.fileName}</span>
                                                                    </button>
                                                                ))}
                                                            </div>
                                                        )}
                                                    </div>
                                                ))
                                            )}
                                        </div>

                                        <Separator className="my-4" />

                                        <div className="space-y-3">
                                            <div className="flex items-start gap-2 p-3 rounded-lg bg-amber-50 dark:bg-amber-950/30 border border-amber-200 dark:border-amber-800">
                                                <AlertCircle className="h-4 w-4 text-amber-600 dark:text-amber-400 mt-0.5 shrink-0" />
                                                <div className="text-xs text-amber-700 dark:text-amber-300">
                                                    <span className="font-semibold">Catatan internal - TIDAK terlihat oleh pelanggan.</span>
                                                    <span className="ml-1">Gunakan untuk dokumentasi atau koordinasi tim.</span>
                                                </div>
                                            </div>
                                            <Label className="text-sm font-medium">Tambah Catatan Internal</Label>
                                            <Textarea
                                                placeholder="Catatan internal (tidak terlihat pelanggan)..."
                                                rows={3}
                                                value={noteText}
                                                onChange={(e) => setNoteText(e.target.value)}
                                                className="resize-none"
                                            />

                                            {/* Note Attachments */}
                                            {noteAttachments.length > 0 && (
                                                <div className="flex flex-wrap gap-2">
                                                    {noteAttachments.map((att, idx) => (
                                                        <div key={idx} className="flex items-center gap-1 text-xs border rounded px-2 py-1 bg-muted/50">
                                                            <Paperclip className="h-3 w-3" />
                                                            <span className="truncate max-w-[120px]">{att.fileName}</span>
                                                            <button
                                                                type="button"
                                                                onClick={() => setNoteAttachments(prev => prev.filter((_, i) => i !== idx))}
                                                                className="text-muted-foreground hover:text-red-500"
                                                            >
                                                                ×
                                                            </button>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}

                                            <div className="flex items-center gap-2">
                                                <input
                                                    ref={noteFileInputRef}
                                                    type="file"
                                                    className="hidden"
                                                    accept=".pdf,.jpg,.jpeg,.png,.gif,.webp,.doc,.docx"
                                                    multiple
                                                    onChange={handleNoteFileUpload}
                                                />
                                                <Button
                                                    type="button"
                                                    variant="outline"
                                                    size="sm"
                                                    onClick={() => noteFileInputRef.current?.click()}
                                                    disabled={isUploadingNote}
                                                >
                                                    {isUploadingNote ? (
                                                        <Loader2 className="h-4 w-4 animate-spin" />
                                                    ) : (
                                                        <Paperclip className="h-4 w-4" />
                                                    )}
                                                    Lampiran
                                                </Button>
                                                <Button variant="secondary" onClick={handleAddNote} disabled={isSubmitting || !noteText.trim()}>
                                                    <FileText className="h-4 w-4" />
                                                    {isSubmitting ? "Menyimpan..." : "Simpan Catatan"}
                                                </Button>
                                            </div>
                                        </div>
                                    </TabsContent>

                                    {/* Activity Tab - Using TicketTimeline component */}
                                    <TabsContent value="activity" className="mt-0">
                                        <TicketTimeline activities={ticket.activities} />
                                    </TabsContent>
                                </CardContent>
                            </Tabs>
                        </Card>
                    </div>

                    {/* Sidebar - Consolidated with collapsible sections */}
                    <div className="lg:sticky lg:top-6 lg:self-start">
                        <TicketDetailSidebar
                            ticket={ticket}
                            onStatusChange={handleStatusChange}
                            onPriorityChange={handlePriorityChange}
                            onEscalate={handleEscalate}
                        />
                    </div>
                </div>
            </div>

            {/* Attachment Viewer Modal */}
            <AttachmentViewer
                file={attachmentViewer.file}
                open={attachmentViewer.open}
                onOpenChange={attachmentViewer.setOpen}
            />
        </>
    );
}
